{% extends 'base.html' %}
{% load static %}

{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä –º–µ–º–æ–≤ - B52_memes{% endblock %}

{% block extra_head %}
<style>
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    .editor-page {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }

    /* –®–∞–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    .editor-header {
        position: sticky;
        top: 0;
        z-index: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px 20px;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
    }

    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ */
    .back-button {
        color: #4a5568;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: color 0.2s ease;
        flex-shrink: 0;
    }

    .back-button:hover {
        color: #4299e1;
    }

    .back-icon {
        padding: 6px;
        border-radius: 8px;
        background: #f7fafc;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .back-button:hover .back-icon {
        background: #edf2f7;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .editor-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        text-align: center;
        flex-grow: 1;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–±–ª–æ–Ω–∞ */
    .template-indicator {
        color: #718096;
        font-size: 16px;
        font-weight: 500;
        flex-shrink: 0;
        text-align: right;
        min-width: 120px;
    }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç */
    .editor-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 32px 20px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –º–µ–º–æ–≤ */
    .meme-editor-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .editor-toolbar {
        display: flex;
        gap: 12px;
        padding: 20px;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    .editor-tool {
        padding: 12px 20px;
        background: white;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        font-size: 16px;
    }

    .editor-tool:hover {
        background: #edf2f7;
        border-color: #a0aec0;
    }

    /* –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ–º" - –°–ò–ù–Ø–Ø */
    .save-button {
        background: #3b82f6 !important;
        color: white !important;
        border-color: #3b82f6 !important;
        font-weight: 600;
    }

    .save-button:hover {
        background: #2563eb !important;
        border-color: #2563eb !important;
    }

    .canvas-container {
        padding: 40px;
        display: flex;
        justify-content: center;
        background: #f1f5f9;
        min-height: 600px;
        position: relative;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞ */
    .canvas-wrapper {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        position: relative;
    }

    #meme-canvas {
        width: 800px !important;
        height: 600px !important;
        background: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-radius: 8px;
        cursor: move;
    }

    /* –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ */
    .text-editor-panel {
        position: absolute;
        top: 40px;
        right: 40px;
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        z-index: 100;
        width: 350px;
        display: none;
        border: 1px solid #e2e8f0;
    }

    .text-editor-panel.active {
        display: block;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e2e8f0;
    }

    .panel-title {
        font-size: 20px;
        font-weight: 600;
        color: #2d3748;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #718096;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
    }

    .close-btn:hover {
        background: #f7fafc;
        color: #4a5568;
    }

    .text-input-group {
        margin-bottom: 20px;
    }

    .text-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 14px;
    }

    .text-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s;
    }

    .text-input:focus {
        outline: none;
        border-color: #4299e1;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ */
    .font-size-slider-container {
        margin-bottom: 20px;
    }

    .font-size-slider-container label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 14px;
    }

    .font-size-slider-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .font-size-slider {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
    }

    .font-size-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4299e1;
        cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .font-size-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4299e1;
        cursor: pointer;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .font-size-value {
        min-width: 40px;
        text-align: center;
        font-weight: 600;
        color: #4299e1;
        font-size: 16px;
    }

    .font-selector {
        margin-bottom: 20px;
    }

    .font-selector label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 14px;
    }

    .font-dropdown {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        cursor: pointer;
    }

    .font-dropdown:focus {
        outline: none;
        border-color: #4299e1;
    }

    .text-position-selector {
        margin-bottom: 20px;
    }

    .text-position-selector label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 14px;
    }

    .position-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 8px;
    }

    .position-btn {
        padding: 10px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        text-align: center;
        font-weight: 500;
    }

    .position-btn:hover {
        background: #f7fafc;
        border-color: #a0aec0;
    }

    .position-btn.active {
        background: #4299e1;
        color: white;
        border-color: #4299e1;
    }

    .color-picker {
        margin-bottom: 20px;
    }

    .color-picker label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4a5568;
        font-size: 14px;
    }

    .color-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.2s, border-color 0.2s;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.active {
        border-color: #4299e1;
        transform: scale(1.05);
    }

    .editor-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
        transition: background-color 0.2s;
    }

    .save-text-btn {
        background: #48bb78;
        color: white;
    }

    .save-text-btn:hover {
        background: #38a169;
    }

    .delete-text-btn {
        background: #f56565;
        color: white;
    }

    .delete-text-btn:hover {
        background: #e53e3e;
    }

    .new-text-btn {
        background: #4299e1;
        color: white;
    }

    .new-text-btn:hover {
        background: #3182ce;
    }

    /* –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤ */
    .texts-list-panel {
        position: absolute;
        bottom: 40px;
        right: 40px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 99;
        width: 300px;
        max-height: 300px;
        overflow-y: auto;
    }

    .texts-list-header {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #2d3748;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .text-item {
        padding: 10px 12px;
        margin-bottom: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f7fafc;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .text-item:hover {
        background: #edf2f7;
        border-color: #cbd5e0;
    }

    .text-item.active {
        background: #bee3f8;
        border-color: #4299e1;
    }

    .text-item-content {
        font-size: 14px;
        color: #2d3748;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
    }

    .text-item-actions {
        display: flex;
        gap: 6px;
    }

    .text-action-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #718096;
        padding: 4px 6px;
        border-radius: 4px;
        font-size: 14px;
    }

    .text-action-btn:hover {
        background: #e2e8f0;
        color: #4a5568;
    }

    /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ */
    .add-text-hint {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 18px;
        display: none;
        z-index: 90;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* –®–∞–±–ª–æ–Ω—ã –º–µ–º–æ–≤ */
    .templates-section {
        margin-top: 40px;
        background: white;
        border-radius: 12px;
        padding: 32px;
    }

    .templates-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 8px;
    }

    .templates-subtitle {
        color: #718096;
        font-size: 16px;
        margin-bottom: 24px;
    }

    .templates-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .template-card {
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
        border: 1px solid #e2e8f0;
        background: white;
    }

    .template-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    .template-card img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        display: block;
    }

    .template-info {
        padding: 16px;
    }

    .template-name {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 4px;
    }

    .template-category {
        font-size: 14px;
        color: #718096;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-page">
    <!-- –®–∞–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
    <header class="editor-header">
        <div class="header-container">
            <div class="header-content">
                <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
                <a href="{% url 'memes:gallery' %}" class="back-button">
                    <div class="back-icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </div>
                    <span>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</span>
                </a>

                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <h1 class="editor-title">–†–µ–¥–∞–∫—Ç–æ—Ä –º–µ–º–æ–≤</h1>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–±–ª–æ–Ω–∞ -->
                <div class="template-indicator">
                    {% if template %}
                        –®–∞–±–ª–æ–Ω #{{ template.id }}
                    {% else %}
                        –ù–æ–≤—ã–π –º–µ–º
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="editor-content">
        <div class="meme-editor-container">
            <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
            <div class="editor-toolbar">
                <button class="editor-tool" onclick="openTextEditor()">
                    ‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
                </button>
                <button class="editor-tool" onclick="uploadImage()">
                    üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </button>
                <button class="editor-tool save-button" onclick="saveMeme()">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ–º
                </button>
            </div>

            <!-- –•–æ–ª—Å—Ç –¥–ª—è –º–µ–º–∞ -->
            <div class="canvas-container">
                <div class="canvas-wrapper">
                    <canvas id="meme-canvas" width="800" height="600"></canvas>

                    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ -->
                    <div class="add-text-hint" id="add-text-hint">
                        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ö–æ–ª—Å—Ç, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ —ç—Ç–æ –º–µ—Å—Ç–æ
                    </div>

                    <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                    <input type="file" id="image-input" accept="image/*" style="display: none;">
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ -->
                <div class="text-editor-panel" id="text-editor-panel">
                    <div class="panel-header">
                        <div class="panel-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</div>
                        <button class="close-btn" onclick="closeTextEditor()">√ó</button>
                    </div>

                    <div class="text-input-group">
                        <label for="text-content">–¢–µ–∫—Å—Ç:</label>
                        <input type="text" id="text-content" class="text-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –º–µ–º–∞" maxlength="100">
                    </div>

                    <!-- –ü–æ–ª–∑—É–Ω–æ–∫ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ -->
                    <div class="font-size-slider-container">
                        <label>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: <span id="font-size-value">36px</span></label>
                        <div class="font-size-slider-wrapper">
                            <input type="range"
                                   min="20"
                                   max="72"
                                   value="36"
                                   class="font-size-slider"
                                   id="font-size-slider"
                                   oninput="updateFontSizeValue(this.value)">
                        </div>
                    </div>

                    <div class="font-selector">
                        <label for="font-select">–®—Ä–∏—Ñ—Ç:</label>
                        <select id="font-select" class="font-dropdown">
                            <option value="Impact">Impact</option>
                            <option value="Arial">Arial</option>
                            <option value="Comic Sans MS">Comic Sans MS</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Verdana">Verdana</option>
                            <option value="Courier New">Courier New</option>
                        </select>
                    </div>

                    <div class="text-position-selector">
                        <label>–ü–æ–∑–∏—Ü–∏—è —Ç–µ–∫—Å—Ç–∞:</label>
                        <div class="position-grid" id="position-selector">
                            <button class="position-btn" data-position="top">–í–µ—Ä—Ö</button>
                            <button class="position-btn" data-position="center">–¶–µ–Ω—Ç—Ä</button>
                            <button class="position-btn" data-position="bottom">–ù–∏–∑</button>
                            <button class="position-btn active" data-position="custom">–°–≤–æ–π</button>
                        </div>
                    </div>

                    <div class="color-picker">
                        <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
                        <div class="color-grid" id="text-color-picker">
                            <div class="color-option active" style="background: #FFFFFF;" data-color="#FFFFFF" title="–ë–µ–ª—ã–π"></div>
                            <div class="color-option" style="background: #000000;" data-color="#000000" title="–ß–µ—Ä–Ω—ã–π"></div>
                            <div class="color-option" style="background: #FF0000;" data-color="#FF0000" title="–ö—Ä–∞—Å–Ω—ã–π"></div>
                            <div class="color-option" style="background: #00FF00;" data-color="#00FF00" title="–ó–µ–ª–µ–Ω—ã–π"></div>
                            <div class="color-option" style="background: #0000FF;" data-color="#0000FF" title="–°–∏–Ω–∏–π"></div>
                            <div class="color-option" style="background: #FFFF00;" data-color="#FFFF00" title="–ñ–µ–ª—Ç—ã–π"></div>
                            <div class="color-option" style="background: #FF00FF;" data-color="#FF00FF" title="–ü—É—Ä–ø—É—Ä–Ω—ã–π"></div>
                            <div class="color-option" style="background: #00FFFF;" data-color="#00FFFF" title="–ë–∏—Ä—é–∑–æ–≤—ã–π"></div>
                            <div class="color-option" style="background: #FFA500;" data-color="#FFA500" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π"></div>
                            <div class="color-option" style="background: #800080;" data-color="#800080" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"></div>
                        </div>
                    </div>

                    <div class="color-picker">
                        <label>–¶–≤–µ—Ç –æ–±–≤–æ–¥–∫–∏:</label>
                        <div class="color-grid" id="stroke-color-picker">
                            <div class="color-option" style="background: #000000;" data-color="#000000" title="–ß–µ—Ä–Ω—ã–π"></div>
                            <div class="color-option active" style="background: #FFFFFF;" data-color="#FFFFFF" title="–ë–µ–ª—ã–π"></div>
                            <div class="color-option" style="background: #FF0000;" data-color="#FF0000" title="–ö—Ä–∞—Å–Ω—ã–π"></div>
                            <div class="color-option" style="background: #0000FF;" data-color="#0000FF" title="–°–∏–Ω–∏–π"></div>
                            <div class="color-option" style="background: #FFFF00;" data-color="#FFFF00" title="–ñ–µ–ª—Ç—ã–π"></div>
                        </div>
                    </div>

                    <div class="editor-actions">
                        <button class="action-btn save-text-btn" onclick="saveText()">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button class="action-btn delete-text-btn" onclick="deleteText()">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                        <button class="action-btn new-text-btn" onclick="addNewText()">
                            –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç
                        </button>
                    </div>
                </div>

                <!-- –ü–∞–Ω–µ–ª—å —Å–ø–∏—Å–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤ -->
                <div class="texts-list-panel" id="texts-list-panel">
                    <div class="texts-list-header">
                        <span>–¢–µ–∫—Å—Ç—ã (<span id="texts-count">0</span>)</span>
                        <button class="text-action-btn" onclick="toggleTextsList()">√ó</button>
                    </div>
                    <div id="texts-list">
                        <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- –®–∞–±–ª–æ–Ω—ã –º–µ–º–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
        {% if templates %}
        <div class="templates-section">
            <h2 class="templates-title">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω</h2>
            <p class="templates-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
            <div class="templates-grid">
                {% for template_item in templates %}
                <a href="{% url 'memes:editor_template' template_item.id %}"
                   class="template-card">
                    <img src="{{ template_item.image.url }}"
                         alt="{{ template_item.name }}"
                         loading="lazy">
                    <div class="template-info">
                        <h3 class="template-name">{{ template_item.name }}</h3>
                        {% if template_item.category %}
                        <div class="template-category">{{ template_item.get_category_display }}</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    const canvas = document.getElementById('meme-canvas');
    const ctx = canvas.getContext('2d');
    let memeData = {
        texts: [],
        images: [],
        template: null,
        currentTextIndex: -1,
        editingMode: false
    };

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const textEditorPanel = document.getElementById('text-editor-panel');
    const textsListPanel = document.getElementById('texts-list-panel');
    const textsList = document.getElementById('texts-list');
    const textContentInput = document.getElementById('text-content');
    const fontSelect = document.getElementById('font-select');
    const fontSizeSlider = document.getElementById('font-size-slider');
    const fontSizeValue = document.getElementById('font-size-value');
    const textsCount = document.getElementById('texts-count');
    const positionSelector = document.getElementById('position-selector');
    const textColorPicker = document.getElementById('text-color-picker');
    const strokeColorPicker = document.getElementById('stroke-color-picker');
    const addTextHint = document.getElementById('add-text-hint');

    // –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
    const textPositions = {
        'top': { x: 0.5, y: 0.1, align: 'center' },
        'center': { x: 0.5, y: 0.5, align: 'center' },
        'bottom': { x: 0.5, y: 0.9, align: 'center' },
        'custom': { x: 0.5, y: 0.5, align: 'center' }
    };

    // –¢–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
    let currentFontSize = 36;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function initializeEditor() {
        {% if template %}
            loadTemplate({{ template.id }});
        {% else %}
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#718096';
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω',
                        canvas.width / 2,
                        canvas.height / 2);
        {% endif %}

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
        initColorPickers();
        initPositionSelector();
        initFontSizeSlider();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        initEventListeners();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤
        updateTextsCount();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
    function initColorPickers() {
        // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
        textColorPicker.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                textColorPicker.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –æ–±–≤–æ–¥–∫–∏
        strokeColorPicker.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                strokeColorPicker.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
    function initPositionSelector() {
        positionSelector.querySelectorAll('.position-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                positionSelector.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∑—É–Ω–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
    function initFontSizeSlider() {
        fontSizeSlider.addEventListener('input', function() {
            updateFontSizeValue(this.value);
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
    function updateFontSizeValue(value) {
        currentFontSize = parseInt(value);
        fontSizeValue.textContent = value + 'px';

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        if (memeData.editingMode && memeData.currentTextIndex >= 0) {
            memeData.texts[memeData.currentTextIndex].fontSize = currentFontSize;
            redrawCanvas();
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function initEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        document.getElementById('image-input').addEventListener('change', handleImageUpload);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à–∏ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–µ–π
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTextEditor();
                hideAddTextHint();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –ø–∞–Ω–µ–ª–µ–π
        document.addEventListener('click', function(e) {
            if (!textEditorPanel.contains(e.target) && !textsListPanel.contains(e.target) &&
                !e.target.closest('.editor-tool') && e.target !== canvas) {
                if (textEditorPanel.classList.contains('active')) {
                    closeTextEditor();
                }
            }
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–∞
    function loadTemplate(templateId) {
        fetch(`/api/template/${templateId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                return response.json();
            })
            .then(template => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    memeData.template = template;
                    memeData.images = [{
                        src: template.image_url,
                        type: 'template'
                    }];

                    addDefaultTexts();
                    updateTextsList();
                };
                img.onerror = function() {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞');
                };
                img.src = template.image_url;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–∞: ' + error.message);
            });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#f56565';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
    function addDefaultTexts() {
        addTextWithData('–í–µ—Ä—Ö–Ω–∏–π —Ç–µ–∫—Å—Ç', 0.5, 0.1, 'center', 36);
        addTextWithData('–ù–∏–∂–Ω–∏–π —Ç–µ–∫—Å—Ç', 0.5, 0.9, 'center', 36);
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    function openTextEditor() {
        textEditorPanel.classList.add('active');
        textsListPanel.style.display = 'block';

        if (memeData.currentTextIndex >= 0 && memeData.texts[memeData.currentTextIndex]) {
            // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
            memeData.editingMode = true;
            const text = memeData.texts[memeData.currentTextIndex];
            textContentInput.value = text.text;
            fontSelect.value = text.fontFamily;
            fontSizeSlider.value = text.fontSize;
            updateFontSizeValue(text.fontSize);

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
            textColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.toggle('active', option.dataset.color === text.color);
            });

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –æ–±–≤–æ–¥–∫–∏
            strokeColorPicker.querySelectorAll('.color-option').forEach(option => {
                option.classList.toggle('active', option.dataset.color === text.strokeColor);
            });

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—É—é
            positionSelector.querySelectorAll('.position-btn').forEach(btn => {
                if (btn.dataset.position === 'custom') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        } else {
            // –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            memeData.editingMode = false;
            textContentInput.value = '';
            textContentInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –º–µ–º–∞';
            fontSizeSlider.value = currentFontSize;
            updateFontSizeValue(currentFontSize);

            // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ "–°–≤–æ–π"
            positionSelector.querySelectorAll('.position-btn').forEach(btn => {
                if (btn.dataset.position === 'custom') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
            showAddTextHint();
        }

        textContentInput.focus();
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
    function closeTextEditor() {
        textEditorPanel.classList.remove('active');
        hideAddTextHint();
        memeData.currentTextIndex = -1;
        redrawCanvas();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
    function showAddTextHint() {
        addTextHint.style.display = 'block';
    }

    // –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
    function hideAddTextHint() {
        addTextHint.style.display = 'none';
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    function addNewText() {
        memeData.editingMode = false;
        memeData.currentTextIndex = -1;
        textContentInput.value = '';
        textContentInput.focus();
        showAddTextHint();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    function saveText() {
        const text = textContentInput.value.trim();
        if (!text) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
        const positionBtn = positionSelector.querySelector('.position-btn.active');
        const positionType = positionBtn.dataset.position;
        let position = textPositions[positionType];

        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞
        const textColor = textColorPicker.querySelector('.color-option.active').dataset.color;
        const strokeColor = strokeColorPicker.querySelector('.color-option.active').dataset.color;
        const fontFamily = fontSelect.value;

        if (memeData.editingMode && memeData.currentTextIndex >= 0) {
            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
            const textObj = memeData.texts[memeData.currentTextIndex];
            textObj.text = text;
            textObj.color = textColor;
            textObj.strokeColor = strokeColor;
            textObj.fontFamily = fontFamily;
            textObj.fontSize = currentFontSize;
            textObj.align = position.align;

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –Ω–µ –∫–∞—Å—Ç–æ–º–Ω–∞—è
            if (positionType !== 'custom') {
                textObj.x = position.x;
                textObj.y = position.y;
            }
        } else {
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ä–µ–∂–∏–º, –∂–¥–µ–º –∫–ª–∏–∫–∞ –Ω–∞ —Ö–æ–ª—Å—Ç–µ
            if (positionType === 'custom') {
                showAddTextHint();
                return; // –ü–æ–∑–∏—Ü–∏—è –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ö–æ–ª—Å—Ç
            }

            addTextWithData(text, position.x, position.y, position.align, currentFontSize, textColor, strokeColor, fontFamily);
        }

        redrawCanvas();
        updateTextsList();
        closeTextEditor();
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    function addTextWithData(text, x, y, align = 'center', fontSize = 36, color = '#FFFFFF', strokeColor = '#000000', fontFamily = 'Impact') {
        memeData.texts.push({
            text: text,
            x: x,
            y: y,
            fontSize: fontSize,
            fontFamily: fontFamily,
            color: color,
            strokeColor: strokeColor,
            strokeWidth: 3,
            align: align,
            font: fontSize + 'px ' + fontFamily
        });

        memeData.currentTextIndex = memeData.texts.length - 1;
        memeData.editingMode = true;

        redrawCanvas();
        updateTextsList();
        updateTextsCount();
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    function deleteText() {
        if (memeData.currentTextIndex >= 0 && memeData.texts[memeData.currentTextIndex]) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç?')) {
                memeData.texts.splice(memeData.currentTextIndex, 1);
                memeData.currentTextIndex = -1;
                redrawCanvas();
                updateTextsList();
                updateTextsCount();
                closeTextEditor();
            }
        } else {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!');
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if (!file.type.match('image.*')) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                memeData.images = [{
                    src: e.target.result,
                    type: 'uploaded'
                }];

                memeData.template = null;
                memeData.texts = [];
                memeData.currentTextIndex = -1;

                updateTextsList();
                updateTextsCount();
                closeTextEditor();
            };
            img.onerror = function() {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            };
            img.src = e.target.result;
        };
        reader.onerror = function() {
            alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
        };
        reader.readAsDataURL(file);
    }

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ö–æ–ª—Å—Ç–∞
    function redrawCanvas() {
        // –û—á–∏—â–∞–µ–º —Ö–æ–ª—Å—Ç
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –µ–≥–æ
        if (memeData.images.length > 0) {
            const img = new Image();
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                drawTexts();
            };
            img.src = memeData.images[0].src;
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ä–∏—Å—É–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawTexts();
        }
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤
    function drawTexts() {
        memeData.texts.forEach((textData, index) => {
            ctx.font = `${textData.fontSize}px ${textData.fontFamily}`;
            ctx.fillStyle = textData.color;
            ctx.strokeStyle = textData.strokeColor;
            ctx.lineWidth = textData.strokeWidth || 3;
            ctx.textAlign = textData.align || 'center';
            ctx.textBaseline = 'middle';

            const canvasX = textData.x * canvas.width;
            const canvasY = textData.y * canvas.height;

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            if (index === memeData.currentTextIndex) {
                ctx.save();
                ctx.strokeStyle = '#4299e1';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);

                const metrics = ctx.measureText(textData.text);
                const textWidth = metrics.width;
                const textHeight = textData.fontSize;

                ctx.strokeRect(
                    canvasX - (textData.align === 'center' ? textWidth/2 : textData.align === 'right' ? textWidth : 0) - 5,
                    canvasY - textHeight/2 - 5,
                    textWidth + 10,
                    textHeight + 10
                );
                ctx.restore();
            }

            // –†–∏—Å—É–µ–º –æ–±–≤–æ–¥–∫—É –∏ –∑–∞–ª–∏–≤–∫—É —Ç–µ–∫—Å—Ç–∞
            ctx.strokeText(textData.text, canvasX, canvasY);
            ctx.fillText(textData.text, canvasX, canvasY);
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤
    function updateTextsList() {
        textsList.innerHTML = '';

        memeData.texts.forEach((textData, index) => {
            const textItem = document.createElement('div');
            textItem.className = 'text-item';
            if (index === memeData.currentTextIndex) {
                textItem.classList.add('active');
            }

            // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π HTML
            const content = document.createElement('div');
            content.className = 'text-item-content';
            content.textContent = textData.text;

            const actions = document.createElement('div');
            actions.className = 'text-item-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'text-action-btn';
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
            editBtn.onclick = (e) => {
                e.stopPropagation();
                editText(index);
            };

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-action-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteTextItem(index);
            };

            actions.appendChild(editBtn);
            actions.appendChild(deleteBtn);

            textItem.appendChild(content);
            textItem.appendChild(actions);

            textItem.addEventListener('click', (e) => {
                if (!e.target.classList.contains('text-action-btn')) {
                    selectText(index);
                }
            });

            textsList.appendChild(textItem);
        });

        updateTextsCount();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤
    function updateTextsCount() {
        textsCount.textContent = memeData.texts.length;
    }

    // –í—ã–±–æ—Ä —Ç–µ–∫—Å—Ç–∞
    function selectText(index) {
        memeData.currentTextIndex = index;
        memeData.editingMode = true;

        const text = memeData.texts[index];
        textContentInput.value = text.text;
        fontSelect.value = text.fontFamily;
        fontSizeSlider.value = text.fontSize;
        updateFontSizeValue(text.fontSize);

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
        textColorPicker.querySelectorAll('.color-option').forEach(option => {
            option.classList.toggle('active', option.dataset.color === text.color);
        });

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–≤–µ—Ç–∞ –æ–±–≤–æ–¥–∫–∏
        strokeColorPicker.querySelectorAll('.color-option').forEach(option => {
            option.classList.toggle('active', option.dataset.color === text.strokeColor);
        });

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –∫–∞—Å—Ç–æ–º–Ω—É—é
        positionSelector.querySelectorAll('.position-btn').forEach(btn => {
            if (btn.dataset.position === 'custom') {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        openTextEditor();
        redrawCanvas();
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    function editText(index) {
        selectText(index);
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
    function deleteTextItem(index) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç?')) {
            memeData.texts.splice(index, 1);
            if (memeData.currentTextIndex === index) {
                memeData.currentTextIndex = -1;
            } else if (memeData.currentTextIndex > index) {
                memeData.currentTextIndex--;
            }
            redrawCanvas();
            updateTextsList();
            updateTextsCount();
            closeTextEditor();
        }
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤
    function toggleTextsList() {
        textsListPanel.style.display = textsListPanel.style.display === 'none' ? 'block' : 'none';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ö–æ–ª—Å—Ç—É
    canvas.addEventListener('click', function(event) {
        const rect = canvas.getBoundingClientRect();
        const x = (event.clientX - rect.left) / canvas.width;
        const y = (event.clientY - rect.top) / canvas.height;

        if (addTextHint.style.display === 'block') {
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∫–∞—Å—Ç–æ–º–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
            const text = textContentInput.value.trim();
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º!');
                return;
            }

            const textColor = textColorPicker.querySelector('.color-option.active').dataset.color;
            const strokeColor = strokeColorPicker.querySelector('.color-option.active').dataset.color;
            const fontFamily = fontSelect.value;

            addTextWithData(text, x, y, 'center', currentFontSize, textColor, strokeColor, fontFamily);
            hideAddTextHint();
            closeTextEditor();
        } else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ç–µ–∫—Å—Ç—É
            let selectedIndex = -1;

            memeData.texts.forEach((textData, index) => {
                ctx.font = `${textData.fontSize}px ${textData.fontFamily}`;
                const metrics = ctx.measureText(textData.text);
                const textWidth = metrics.width;
                const textHeight = textData.fontSize;

                const canvasX = textData.x * canvas.width;
                const canvasY = textData.y * canvas.height;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞
                const left = canvasX - (textData.align === 'center' ? textWidth/2 : textData.align === 'right' ? textWidth : 0);
                const right = left + textWidth;
                const top = canvasY - textHeight/2;
                const bottom = top + textHeight;

                const clickX = event.clientX - rect.left;
                const clickY = event.clientY - rect.top;

                if (clickX >= left && clickX <= right && clickY >= top && clickY <= bottom) {
                    selectedIndex = index;
                }
            });

            if (selectedIndex >= 0) {
                selectText(selectedIndex);
            } else {
                // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ —Ç–µ–∫—Å—Ç—É, —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                memeData.currentTextIndex = -1;
                redrawCanvas();
                closeTextEditor();
            }
        }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–º–∞
    function saveMeme() {
        if (memeData.images.length === 0 && !memeData.template) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω!');
            return;
        }

        const imageData = canvas.toDataURL('image/png');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const saveButton = document.querySelector('.save-button');
        const originalText = saveButton.textContent;
        saveButton.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        saveButton.disabled = true;

        fetch('{% url "memes:save_meme_image" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                image_data: imageData,
                meme_data: memeData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ú–µ–º —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                window.location.href = '{% url "memes:user_memes" %}';
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–µ–º–∞');
        })
        .finally(() => {
            saveButton.textContent = originalText;
            saveButton.disabled = false;
        });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function uploadImage() {
        document.getElementById('image-input').click();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', initializeEditor);
</script>
{% endblock %}